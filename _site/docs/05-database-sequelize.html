<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Base de datos en desarrollo - Fullstack JS</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Base de datos en desarrollo | Fullstack JS</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Base de datos en desarrollo" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="/docs/05-database-sequelize.html" /> <meta property="og:url" content="/docs/05-database-sequelize.html" /> <meta property="og:site_name" content="Fullstack JS" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Base de datos en desarrollo" /> <script type="application/ld+json"> {"url":"/docs/05-database-sequelize.html","@type":"WebPage","headline":"Base de datos en desarrollo","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Fullstack JS </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Inicio</a></li><li class="nav-list-item"><a href="/docs/01-vue-cli-install.html" class="nav-list-link">Creando proyecto con CLI</a></li><li class="nav-list-item"><a href="/docs/02-bdd-with-cypress.html" class="nav-list-link">Historias de usuario y BDD</a></li><li class="nav-list-item"><a href="/docs/03-monorepo-backend.html" class="nav-list-link">Fullstack Javascript</a></li><li class="nav-list-item"><a href="/docs/04-firebase-sdk-backend.html" class="nav-list-link">Autenticación en backend</a></li><li class="nav-list-item active"><a href="/docs/05-database-sequelize.html" class="nav-list-link active">Base de datos en desarrollo</a></li><li class="nav-list-item"><a href="/docs/06-testing-backend.html" class="nav-list-link">Refactorización con pruebas I</a></li><li class="nav-list-item"><a href="/docs/07-testing-frontend.html" class="nav-list-link">Refactorización con pruebas II</a></li><li class="nav-list-item"><a href="/docs/08-development-workflow-husky.html" class="nav-list-link">Automatización en desarrollo</a></li><li class="nav-list-item"><a href="/docs/09-deployment-postgres.html" class="nav-list-link">Deploy automatizado</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Fullstack JS" aria-label="Search Fullstack JS" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="agregando-base-de-datos-en-desarrollo"> <a href="#agregando-base-de-datos-en-desarrollo" class="anchor-heading" aria-labelledby="agregando-base-de-datos-en-desarrollo"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Agregando base de datos en desarrollo </h1> <p>En esta sección configuraremos una opción muy común para persistir los datos que gestionará la aplicación. Nos referimos a las bases de datos relacionales, las que vienen en un montón de dialectos diferentes (psql, mysql, sqlite, oracle, etc), pero para no tener que decidir ahora cual usar, vamos a emplear una librería que nos entregará una capa de abstracción superior y que podemos configurar según las necesidades de cada entorno (desarrollo, producción, staging, etc). En el caso de Nodejs la librería más popular es <code class="language-plaintext highlighter-rouge">Sequelize</code>. Además de ser un traductor para los diferentes motores específicos de bases de datos, Sequelize es un ORM que entrega muchas facilidades para mantener sincronizada nuestra aplicación con el modelo de datos.</p> <p>Para usar Sequelize nos aseguramos de navegar en la carpeta <code class="language-plaintext highlighter-rouge">backend</code> y ejecuraremos los siguientes comandos:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i sequelize
npm i sequelize-cli sqlite3 <span class="nt">--save-dev</span>
</code></pre></div></div> <p>Con estos comandos hemos agregado <code class="language-plaintext highlighter-rouge">Sequelize</code> como dependencia general y <code class="language-plaintext highlighter-rouge">Sequelize-cli</code> y <code class="language-plaintext highlighter-rouge">Sqlite3</code> como dependencias de desarrollo. Estás últimas nos permitirán modelar de forma más ágil y ligera nuestras bases de datos de desarrollo. Más adelante, cuando estemos próximos al despliegue a producción seleccionaremos y configuraremos la base de datos para el ambiente productivo.</p> <p>Para no tener que instalar el CLI de Sequelize en forma global, podemos exponer el comando desde el mismo directorio node_modules del proyecto y así usarlo de forma local. Para eso hay que modificar el archivo <code class="language-plaintext highlighter-rouge">backend/package.json</code> de la siguiente forma:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">...</span>
  <span class="dl">"</span><span class="s2">scripts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nodemon src/server.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sequelize</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sequelize</span><span class="dl">"</span><span class="p">,</span> 
    <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1</span><span class="dl">"</span>
  <span class="p">},</span>
<span class="p">...</span>
</code></pre></div></div> <p>Sequelize-cli por defecto creará los modelos y las migraciones en la carpeta raíz, pero para definir que estos archivos se creen dentro del directorio <code class="language-plaintext highlighter-rouge">backend/src</code> (debido a la estructura de directorio que estamos utilizando) debemos configurarlo mediante un archivo denominado <code class="language-plaintext highlighter-rouge">.sequelizerc</code> en la carpeta <code class="language-plaintext highlighter-rouge">backend</code> con el siguiente contenido:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
 <span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./src/config</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">config.json</span><span class="dl">'</span><span class="p">),</span>
 <span class="dl">'</span><span class="s1">models-path</span><span class="dl">'</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./src/models</span><span class="dl">'</span><span class="p">),</span>
 <span class="dl">'</span><span class="s1">seeders-path</span><span class="dl">'</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./src/seeders</span><span class="dl">'</span><span class="p">),</span>
 <span class="dl">'</span><span class="s1">migrations-path</span><span class="dl">'</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./src/migrations</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div></div> <p>Ahora podemos ejecutar en la terminal de Backend el siguiente comando:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run sequelize init
</code></pre></div></div> <p>Esto creará las carpetas <code class="language-plaintext highlighter-rouge">/config</code>, <code class="language-plaintext highlighter-rouge">/models</code>, <code class="language-plaintext highlighter-rouge">/config</code> y <code class="language-plaintext highlighter-rouge">/seeders</code> dentro del directorio <code class="language-plaintext highlighter-rouge">backend/src</code>. Este último luego de los comandos que hemos ejecutado debería verse como el siguiente esquema:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;backend&gt;
├── node_modules
├── src
    ├── config
    ├── migrations
    ├── models
    ├── seeders
        server.js
.sequelizesrc
firebase-service-account.json
nodemon.json
package-lock.json
package.json
</code></pre></div></div> <p>Ahora continuaremos el desarrollo modificando el dialecto en el entorno de desarrollo. Por defecto es <code class="language-plaintext highlighter-rouge">mysql</code> pero usaremos <code class="language-plaintext highlighter-rouge">sqlite</code> debido a que es más simple de mantener. Para esto modificamos el archivo <code class="language-plaintext highlighter-rouge">backend/src/config/config.json</code></p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">development</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">host</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">local.database.sqlite3</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">dialect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sqlite</span><span class="dl">"</span>
  <span class="p">},</span>
</code></pre></div></div> <p>Ya estamos en condiciones de crear el primer modelo. En este caso crearemos el modelo <code class="language-plaintext highlighter-rouge">Product</code> con los atributos acordados en los Fixtures. En la terminal del backend ejecutaremos el siguiente comando.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npm</span> <span class="nx">run</span> <span class="nx">sequelize</span> <span class="nx">model</span><span class="p">:</span><span class="nx">generate</span> <span class="o">--</span> <span class="o">--</span><span class="nx">name</span> <span class="nx">Product</span> <span class="o">--</span><span class="nx">attributes</span> <span class="nx">name</span><span class="p">:</span><span class="nx">string</span><span class="p">,</span><span class="nx">description</span><span class="p">:</span><span class="nx">string</span><span class="p">,</span><span class="nx">code</span><span class="p">:</span><span class="nx">string</span><span class="p">,</span><span class="nx">image</span><span class="p">:</span><span class="nx">string</span>
</code></pre></div></div> <p>Como profundizamos en el curso, la estructura de la base de datos debe ser modificada utilizando scripts de migración. El comando anterior creó un script que agrega una tabla con el nombre del modelo más los atributos como columnas. Sequelize agrega por defecto el atributo id de típo numérico autoincremental y considera el caso de los atributos <code class="language-plaintext highlighter-rouge">created_at</code> y <code class="language-plaintext highlighter-rouge">updated_at</code>. El valor por defecto de estos dos atributos debemos establecerlo nosotros. Modificaremos el archivo de migración en <code class="language-plaintext highlighter-rouge">backend/src/migrations/[timestamp-generado-por-sequelize]-create-product.js</code> reemplazando el valor de ambos campos con lo que sigue:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">createdAt</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">allowNull</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">type</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">DATE</span><span class="p">,</span>
      <span class="nx">defaultValue</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">literal</span><span class="p">(</span><span class="dl">"</span><span class="s2">CURRENT_TIMESTAMP</span><span class="dl">"</span><span class="p">),</span> 
    <span class="p">},</span>
    <span class="nx">updatedAt</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">allowNull</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">type</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">DATE</span><span class="p">,</span>
      <span class="nx">defaultValue</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">literal</span><span class="p">(</span><span class="dl">"</span><span class="s2">CURRENT_TIMESTAMP</span><span class="dl">"</span><span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></div> <p>Para que esta migración modifique la estructura, debemos ejecutar el archivo de migración con el siguiente comando:</p> <p><code class="language-plaintext highlighter-rouge">npm run sequelize db:migrate</code></p> <p>Para cargar los datos iniciales en el ambiente de desarrollo creamos un archivo conocido como Seed con el siguiente comando:</p> <p><code class="language-plaintext highlighter-rouge">npm run sequelize seed:generate -- --name load-products</code></p> <p>Esto tan solo crea un archivo dentro de la carpeta <code class="language-plaintext highlighter-rouge">/seeders</code> que con simple javascript permite ingresar datos a nuestras tablas. Reemplazaremos todo el contenido del archivo creado. El nombre del archivo es: <code class="language-plaintext highlighter-rouge">backend/src/seeders/[timestamp-generado-por-sequelize]-load-products.js</code></p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fixturesFolder</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">../fixtures</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">fixturesFolder</span><span class="p">}</span><span class="s2">/products.json`</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">up</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">queryInterface</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">queryInterface</span><span class="p">.</span><span class="nx">bulkDelete</span><span class="p">(</span><span class="nx">tableName</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">truncate</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="k">await</span> <span class="nx">queryInterface</span><span class="p">.</span><span class="nx">bulkInsert</span><span class="p">(</span><span class="nx">tableName</span><span class="p">,</span> <span class="nx">products</span><span class="p">,</span> <span class="p">{})</span>
  <span class="p">},</span>
  <span class="na">down</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">queryInterface</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">queryInterface</span><span class="p">.</span><span class="nx">bulkDelete</span><span class="p">(</span><span class="nx">tableName</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">truncate</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div> <p>Al ejecutar el siguiente comando estamos copiando los datos definidos en los fixtures a la base de datos de desarrollo.</p> <p><code class="language-plaintext highlighter-rouge">npm run sequelize db:seed:all</code></p> <p>Es importante notar, que a pesar de que es posible ingresar datos a la base de muchas formas, es mejor seguir esta, ya que los fixtures representan una parte importante del modelo de datos y representan el acuerdo común entre Backend, Frontend y el Dominio de Negocio de nuestra aplicación.</p> <p>Podemos notar que en la raíz del directorio <code class="language-plaintext highlighter-rouge">backend</code> se creó un archivo llamado <code class="language-plaintext highlighter-rouge">local.database.sqlite3</code>. Si contamos con un visor de bases de datos sqlite, podemos cargar este archivo y ver gráficamente el resultado como en la siguiente imágen:</p> <p><img src="images/05-database-sequelize-01.png" alt="visor de bdd" /></p> <p>Recomendamos <code class="language-plaintext highlighter-rouge">DB Browser for SQLite</code> que lo puedes encontrar en el <a href="https://sqlitebrowser.org/dl/">siguiente enlace</a></p> <p>Ahora agregaremos el archivo <code class="language-plaintext highlighter-rouge">local.database.sqlite3</code> a <code class="language-plaintext highlighter-rouge">.gitignore</code> que hasta el momento debería verse de la siguiente manera:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.DS_Store
node_modules
dist

/tests/e2e/videos/
/tests/e2e/screenshots/

firebase-service-account.json
local.database.sqlite3

# local env files
.env.local
.env.*.local

# Log files
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Editor directories and files
.idea
.vscode
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

</code></pre></div></div> <p>Con todo esto ya tenemos nuestro ambiente de Base de datos montado en el ambiente de desarrollo. Solo falta incorporar que la respuesta del servidor entregue los datos desde la BDD</p> <h4 id="agregar-modelos-de-base-de-datos-como-respuesta-a-la-llamada-al-servidor"> <a href="#agregar-modelos-de-base-de-datos-como-respuesta-a-la-llamada-al-servidor" class="anchor-heading" aria-labelledby="agregar-modelos-de-base-de-datos-como-respuesta-a-la-llamada-al-servidor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Agregar modelos de base de datos como respuesta a la llamada al Servidor </h4> <p>Volveremos a dividir nuestro entorno de trabajo en 2 ventanas (o pestañas) de la terminal. Una para el Frontend y otra para el Backend como lo hemos venido haciendo hasta el momento.</p> <ul> <li>Primero para el Backend ejecutamos <code class="language-plaintext highlighter-rouge">npm run dev</code></li> <li>Luego para el Frontend ejecutamos <code class="language-plaintext highlighter-rouge">npm run test:e2e</code> y presionamos el botón <code class="language-plaintext highlighter-rouge">Run all specs</code> en la interfaz de Cypress.</li> </ul> <p>Todas las pruebas deberían estar pasando sin problemas.</p> <p>Ahora modificaremos el archivo <code class="language-plaintext highlighter-rouge">backend/src/server.js</code> y lo reemplazaremos todo su contenido por lo siguiente:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Models</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./models</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span>
<span class="kd">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">({</span><span class="na">credential</span><span class="p">:</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">credential</span><span class="p">.</span><span class="nx">applicationDefault</span><span class="p">()})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">headerToken</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headerToken</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">No token provided</span><span class="dl">"</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="p">[</span><span class="nx">authorizationType</span><span class="p">,</span> <span class="nx">tokenValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">headerToken</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">headerToken</span> <span class="o">&amp;&amp;</span> <span class="nx">authorizationType</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">bearer</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Invalid token</span><span class="dl">"</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">auth</span><span class="p">().</span><span class="nx">verifyIdToken</span><span class="p">(</span><span class="nx">tokenValue</span><span class="p">)</span>
    <span class="nx">next</span><span class="p">()</span>

  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>

    <span class="nx">response</span>
      <span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Could not authorize</span><span class="dl">"</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/products</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span>
  <span class="kd">const</span> <span class="nx">Product</span> <span class="o">=</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">Product</span><span class="p">;</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Product</span><span class="p">.</span><span class="nx">findAll</span><span class="p">()</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`GET with status code </span><span class="p">${</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2"> in /api/products endpoint`</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">response</span>
      <span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">products</span><span class="p">)</span>

  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">message</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
    <span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`GET with status code </span><span class="p">${</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2"> in /api/products endpoint. Error: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nx">response</span>
      <span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`App server listening in mode </span><span class="p">${</span><span class="nx">environment</span><span class="p">}</span><span class="s2"> on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">})</span>

</code></pre></div></div> <p>Hicimos una refactorización del archivo <code class="language-plaintext highlighter-rouge">backend/server.js</code> en el cual normalizaremos el uso de <code class="language-plaintext highlighter-rouge">async/await</code> para ejecutar Promesas y agregaremos un bloque <code class="language-plaintext highlighter-rouge">try/catch</code> para realizar una consulta a la base de datos para traer todos los productos utilizando los modelos de Sequelize y utilizando el método <code class="language-plaintext highlighter-rouge">Product.findAll</code></p> <p>Cuando guardemos el archivo se recargará Nodemon y ahora podemos volver a recargar las pruebas y veremos que siguen pasando. Notaremos que ahora en la terminal la consulta a la base de datos aparece en la terminal como muestra la siguiente imagen:</p> <p><img src="images/05-database-sequelize-02.png" alt="Imagen que muestra la consulta a la base de datos en la terminal del servidor" /></p> <p>Esto es Sequelize en acción realizando consultas SQL a la base de datos por nosotros. En ambiente de desarrollo es deseable poder ver las consultas que se van ejecutando, pero por seguridad y confidencialidad no es algo permitido en el entorno de producción. Esto debemos tenerlo presente en el paso a producción.</p> <p>Ya es momento de un nuevo commit. Debemos detener Frontend y Backend. Volvemos a la raíz del proyecto y escribimos lo siguiente en la terminal:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"refactor(backend-sequelize): Se agregó Sequelize para el manejo de modelos, migraciones y el ambiente de desarrollo para la base de datos"</span>
</code></pre></div></div> <p>Con esto ya tenemos completa la funcionalidad de nuestra aplicación conectados a una Base de datos. En el próximo cápitulo escribiremos pruebas de software de integración tanto en Backend como Frontend de manera de asegurar que la calidad de la solución que hemos escrito no se vea afectada con las sucesivas modificaciones que se hagan en el futuro.</p> <div class="table-wrapper"><table> <tr> <th colspan="2"> <a href="./04-firebase-sdk-backend.md"> <span>⬅️ </span> Validar autenticación en el Backend </a> </th> <th colspan="2"> <a href="./06-testing-frontend-backend.md">Pruebas de software para Backend y Frontend <span>➡️ </span> </a> </th> </tr> </table></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
